#
# Azure Pipelines

trigger:
- gh-pages

pool:
  vmImage: 'ubuntu-latest'

variables:
  NOKOGIRI_USE_SYSTEM_LIBRARIES: true
  gh_user: jterral
  gh_repo: jterral.github.io
  gh_pass: $(GITHUB_TOKEN)
  gh_mail: jonathan.terral@outlook.com

steps:
- task: UseRubyVersion@0
  displayName: '[Ruby] Use Ruby >= 2.5'
  inputs:
    versionSpec: '>= 2.5'
    addToPath: true

- script: |
    sudo apt-get install libxslt-dev libxml2-dev
  displayName: '[Apt] Install dev dependencies'

- script: |
    gem install bundler
  displayName: '[Gem] Install bundler'

- script: |
    bundle install --retry=3 --jobs=4
  displayName: '[Jekyll] Bundle install'

- script: |
    bundle exec jekyll build
  displayName: '[Jekyll] Build Jekyll Static Site to _site'

- task: CopyFiles@2
  displayName: '[Script] Copy files to: $(Build.StagingDirectory)'
  inputs:
    sourceFolder: '_site'
    targetFolder: $(Build.StagingDirectory)

- script: |
    git clean -d -X -f -f
    git reset --hard HEAD
    git checkout master
    git status
  displayName: '[Git] Reset gh-pages and checkout master'

- task: DeleteFiles@1
  displayName: '[Script] Clean all files and folder'
  inputs:
    contents: |
      **/*
      .bundle

- task: CopyFiles@2
  displayName: '[Script] Copy files to: $(Build.StagingDirectory)'
  inputs:
    sourceFolder: $(Build.StagingDirectory)
    targetFolder: $(Build.SourcesDirectory)

- script: |
    git config user.email $(gh_mail)
    git config user.name $(gh_user)
  displayName: '[Git] Configure User'

- script: |
    git status
    git add --all
    git commit -m "Azure Pipelines Bot: Updated site via $(Build.BuildNumber) (hash: $(Build.SourceVersion))"
  displayName: '[Git] Creating commit'

- script: |
    git push origin master
  displayName: '[Git] Push changes to master'
